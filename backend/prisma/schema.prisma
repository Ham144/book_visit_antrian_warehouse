generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Subscription {
  id             String           @id @default(uuid())
  start          DateTime
  plan           SubscriptionPlan @default(TRIAL)
  organizationId String?          @unique
  organizations  Organization?    @relation(fields: [organizationId], references: [name])
}

model Organization {
  name           String        @id @unique
  subscriptionId String?       @unique
  subscription   Subscription?
  AD_HOST        String?
  AD_PORT        String?
  AD_DOMAIN      String?
  AD_BASE_DN     String?
  warehouses     Warehouse[]
  docks          Dock[]
  vehicles       Vehicle[]
  bookings       Booking[]
  accounts       User[]
  vendors Vendor[]
}

model Globalsetting {
  settingName String   @id @default(uuid())
  inUse       Boolean  @default(true)
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum Recurring {
  DAILY // recurringStep menentukan berapa lompatan tiap hari
  WEEKLY //customDay
  MONTHLY //recurringStep menentukan tanggal berapa dalam 1 bulan
}

enum SubscriptionPlan {
  TRIAL
  PRO
  PREMIUM
}

enum Days {
  SENIN
  SELASA
  RABU
  KAMIS
  JUMAT
  SABTU
  MINGGU
}

model Warehouse {
  id          String  @id @default(uuid())
  name        String  @unique
  location    String?
  description String?
  isActive    Boolean @default(true)

  docks                 Dock[]
  homeMembers           User[]        @relation("UserHomeWarehouse")
  bookings              Booking[]
  createdAt             DateTime      @default(now())
  userWarehouseAccesses User[]
  organizationName      String?
  organization          Organization? @relation(fields: [organizationName], references: [name])
}

model Vacant {
  id             String  @id @default(uuid())
  availableFrom  String?
  availableUntil String?
  dockId         String?
  dock           Dock?   @relation(fields: [dockId], references: [id])
  day            Days?

  @@unique([dockId, day])
}

model Vehicle {
  id             String      @id @default(cuid())
  brand          String
  vehicleType    VehicleType
  productionYear Int?

  durasiBongkar Int

  requiresDock DockRequirement @default(NONE)

  description String?
  isActive    Boolean @default(true)
  bookings Booking[]

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  organizationName String
  organization     Organization @relation(fields: [organizationName], references: [name])
}

model Dock {
  id          String    @id @default(cuid())
  name        String
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  photos       String[]
  dockType     DockType
  allowedTypes VehicleType[] // jenis kendaraan yang boleh masuk ke dock ini

  isActive Boolean @default(true)
  priority Int?

  vacants   Vacant[]
  bookings  Booking[]
  busyTimes DockBusyTime[]

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  organizationName String
  organization     Organization @relation(fields: [organizationName], references: [name])
}


model DockBusyTime {
  id              String    @id @default(cuid())
  from            String
  to              String
  reason          String
  dockId          String
  dock            Dock      @relation(fields: [dockId], references: [id], onDelete: Cascade)
  recurring       Recurring //daily hanya ini tanpa recurrintSTEP/recurrintCUSTOM
  recurringStep   Int? //monthly
  recurringCustom Days[] // weekly
  createdAt       DateTime  @default(now())
}

model Booking {
  id                  String        @id @default(cuid())
  code String? //kode antrian
  warehouseId         String
  dockId              String?
  vehicleId           String
  arrivalTime         DateTime
  estimatedFinishTime DateTime? //ini yag direncakan
  actualFinishTime    DateTime? //ini kenyataannya
  status              BookingStatus // waiting, in_progress, finished, canceled
  notes               String?

  Vehicle   Vehicle   @relation(fields: [vehicleId], references: [id])
  Warehouse Warehouse @relation(fields: [warehouseId], references: [id])
  Dock      Dock?     @relation(fields: [dockId], references: [id])

  driverUsername       String
  driver         User    @relation("bookingDriver", fields: [driverUsername], references: [username])
  
  canceledReason String?

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  createByUsername String?
  createdBy User? @relation("bookingCreatedBy", fields: [createByUsername], references: [username])
  organizationName String
  organization     Organization @relation(fields: [organizationName], references: [name])
}

enum BookingStatus {
  IN_PROGRESS
  UNLOADING
  FINISHED
  CANCELED
}

model User {
  username     String   @id
  passwordHash String? // kalau pakai auth lokal
  description  String? @default("ADMIN")
  isActive     Boolean  @default(true)
  displayName  String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  mail String?

  driverPhone   String?
  driverLicense String?

  // homeWarehouse = staff biasa (nullable)
  homeWarehouseId String?
  homeWarehouse   Warehouse? @relation("UserHomeWarehouse", fields: [homeWarehouseId], references: [id])

  accountType AccountType @default(AD)

  //many-to-many 
  warehouseAccess Warehouse[]
  createdBooking Booking[] @relation("bookingCreatedBy")
  bookingAsDriver Booking[] @relation("bookingDriver") 
  
  vendorName String?
  vendor Vendor? @relation(fields: [vendorName], references: [name])
  
  organizations Organization[]
}

model Vendor {
  name String @id
  members User[]
  organizationName String
  organization Organization @relation(fields: [organizationName], references: [name])
}

enum AccountType {
  APP
  AD
}

model Counter {
  id               String      @id @default(uuid())
  organizationName String
  warehouseId      String
  dockId           String
  date             DateTime
  sequence_value   Int

  @@unique([organizationName, warehouseId, dockId, date])
}

enum DockType {
  MANUAL
  FORKLIFT
  SIDE
  REEFER
}

enum VehicleType {
  PICKUP
  CDE
  CDD
  FUSO
  TRONTON
  WINGBOX
  CONTAINER20
  CONTAINER40
}

enum DockRequirement {
  NONE
  FORKLIFT
  SIDE
  REEFER
}
