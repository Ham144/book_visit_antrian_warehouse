generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Subscription {
  id             String           @id @default(uuid())
  start          DateTime
  plan           SubscriptionPlan @default(TRIAL)
  organizationId String?          @unique
  organizations  Organization?    @relation(fields: [organizationId], references: [name])
}

model Organization {
  name           String        @id @unique
  subscriptionId String?       @unique
  subscription   Subscription?
  AD_HOST        String?
  AD_PORT        String?
  AD_DOMAIN      String?
  AD_BASE_DN     String?
  warehouses     Warehouse[]
  docks          Dock[]
  vehicles       Vehicle[]
  bookings       Booking[]
  accounts       User[]
}

model Globalsetting {
  settingName String   @id @default(uuid())
  inUse       Boolean  @default(true)
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum Recurring {
  DAILY // recurringStep menentukan berapa lompatan tiap hari
  WEEKLY //customDay
  MONTHLY //recurringStep menentukan tanggal berapa dalam 1 bulan
}

enum SubscriptionPlan {
  TRIAL
  PRO
  PREMIUM
}

enum Days {
  SENIN
  SELASA
  RABU
  KAMIS
  JUMAT
  SABTU
  MINGGU
}

model Warehouse {
  id          String  @id @default(uuid())
  name        String  @unique
  location    String?
  description String?
  isActive    Boolean @default(true)

  docks                 Dock[]
  homeMembers           User[]        @relation("UserHomeWarehouse")
  bookings              Booking[]
  createdAt             DateTime      @default(now())
  userWarehouseAccesses User[]
  organizationName      String?
  organization          Organization? @relation(fields: [organizationName], references: [name])
}

model Vacant {
  id             String  @id @default(uuid())
  availableFrom  String?
  availableUntil String?
  dockId         String?
  dock           Dock?   @relation(fields: [dockId], references: [id])
  day            Days?

  @@unique([dockId, day])
}

model Vehicle {
  id             String      @id @default(cuid())
  brand          String
  vehicleType    VehicleType
  productionYear Int?

  maxCapacity   Int?
  durasiBongkar Int

  requiresDock DockRequirement @default(NONE)

  drivers     User[]
  description String?
  isActive    Boolean @default(true)
  bookings Booking[]

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  organizationName String
  organization     Organization @relation(fields: [organizationName], references: [name])
}

model Dock {
  id          String    @id @default(cuid())
  name        String
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  photos       String[]
  dockType     DockType
  allowedTypes VehicleType[] // jenis kendaraan yang boleh masuk ke dock ini

  isActive Boolean @default(true)
  priority Int?

  vacants   Vacant[]
  bookings  Booking[]
  busyTimes DockBusyTime[]

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  organizationName String
  organization     Organization @relation(fields: [organizationName], references: [name])
}


model DockBusyTime {
  id              String    @id @default(cuid())
  from            String
  to              String
  reason          String
  dockId          String
  dock            Dock      @relation(fields: [dockId], references: [id], onDelete: Cascade)
  recurring       Recurring
  recurringStep   Int? //daily monthly
  recurringCustom Days[] // weekly
  createdAt       DateTime  @default(now())
}

model Booking {
  id                  String        @id @default(cuid())
  warehouseId         String
  dockId              String?
  vehicleId           String
  arrivalTime         DateTime
  estimatedFinishTime DateTime? //ini yag direncakan
  actualFinishTime    DateTime? //ini kenyataannya
  status              BookingStatus // waiting, in_progress, finished, canceled
  notes               String?

  Vehicle   Vehicle   @relation(fields: [vehicleId], references: [id])
  Warehouse Warehouse @relation(fields: [warehouseId], references: [id])
  Dock      Dock?     @relation(fields: [dockId], references: [id])

  driverId       String
  driver         User    @relation(fields: [driverId], references: [username])
  counterId      Int
  canceledReason String?

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  organizationName String
  organization     Organization @relation(fields: [organizationName], references: [name])
}

enum BookingStatus {
  IN_PROGRESS
  UNLOADING
  FINISHED
  CANCELED
}

model User {
  username     String   @id
  passwordHash String? // kalau pakai auth lokal
  description  String?
  isActive     Boolean  @default(true)
  displayName  String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  driverPhone   String?
  driverLicense String?

  // homeWarehouse = staff biasa (nullable)
  homeWarehouseId String?
  homeWarehouse   Warehouse? @relation("UserHomeWarehouse", fields: [homeWarehouseId], references: [id])
  //one-to-many
  vehicleId       String?
  vehicle         Vehicle?   @relation(fields: [vehicleId], references: [id])

  // many-to-many access (admin area)
  warehouseAccess Warehouse[]

  //many-to-many booking
  bookings Booking[]

  organizations Organization[]
}

model Counter {
  id               Int      @id @default(autoincrement())
  organizationName String
  warehouseId      String
  dockId           String
  date             DateTime
  sequence_value   Int

  @@unique([organizationName, warehouseId, dockId, date])
}

enum DockType {
  MANUAL
  FORKLIFT
  SIDE
  REEFER
}

enum VehicleType {
  PICKUP
  CDE
  CDD
  FUSO
  TRONTON
  WINGBOX
  CONTAINER20
  CONTAINER40
}

enum DockRequirement {
  NONE
  FORKLIFT
  SIDE
  REEFER
}
