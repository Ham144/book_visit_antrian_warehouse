generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* ----------------------------
|  note: JANGAN PAKAI ENUM     |
------------------------------*/

model Subscription {
  id             String           @id @default(uuid())
  start          DateTime
  plan           String @default("TRIAL")
  organizationId String?          @unique
  organizations  Organization?    @relation(fields: [organizationId], references: [name])
}

model Organization {
  name           String        @id @unique
  subscriptionId String?       @unique
  subscription   Subscription?
  warehouses     Warehouse[]
  docks          Dock[]
  vehicles       Vehicle[]
  bookings       Booking[]
  accounts       User[]
  vendors Vendor[]
  //settings
  AD_HOST        String?
  AD_PORT        String?
  AD_DOMAIN      String?
  AD_BASE_DN     String?
  disabledFeatures  String[] @default(["chat", "gps"]) 
  isConfirmBookRequired Boolean? @default(false)
}

model Globalsetting {
  settingName String   @id @default("default")
  inUse       Boolean  @default(true)
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  //settings
}

model Warehouse {
  id          String  @id @default(uuid())
  name        String  @unique
  location    String?
  description String?
  isActive    Boolean @default(true)

  docks                 Dock[]
  homeMembers           User[]        @relation("UserHomeWarehouse")
  bookings              Booking[]
  createdAt             DateTime      @default(now())
  userWarehouseAccesses User[]
  organizationName      String?
  organization          Organization? @relation(fields: [organizationName], references: [name])
  vehicles Vehicle[]
  //settings & Preferences
  delayTolerance Int @default(15)
  intervalMinimalQueueu Int @default(5)
  isAutoEfficientActive Boolean @default(true)
  maximumWeekSelection Int? @default(2)
}

model Vacant {
  id             String  @id @default(uuid())
  availableFrom  String?
  availableUntil String?
  dockId         String?
  dock           Dock?   @relation(fields: [dockId], references: [id])
  day            String

  @@unique([dockId, day])
}

model Vehicle {
  id             String      @id @default(cuid())
  brand          String
  vehicleType    String
  productionYear Int?

  durasiBongkar Int

  description String?
  isActive    Boolean @default(true)
  bookings Booking[]
  warehouseId String?
  isGlobalWarehouse Boolean? @default(true)
  
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  organizationName String
  organization     Organization @relation(fields: [organizationName], references: [name])
}

model Dock {
  id          String    @id @default(cuid())
  name        String
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  photos       String[]
  allowedTypes String[] // jenis kendaraan yang boleh masuk ke dock ini

  isActive Boolean @default(true)
  priority Int?

  vacants   Vacant[]
  bookings  Booking[]
  busyTimes DockBusyTime[]

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  organizationName String
  organization     Organization @relation(fields: [organizationName], references: [name])
}

model DockBusyTime {
  id              String    @id @default(cuid())
  from            String
  to              String
  reason          String
  dockId          String
  dock            Dock      @relation(fields: [dockId], references: [id], onDelete: Cascade)
  recurring       String //daily hanya ini tanpa recurrintSTEP/recurrintCUSTOM
  recurringStep   Int? //monthly
  recurringCustom String[] // weekly
  createdAt       DateTime  @default(now())
}

model Booking {
  id                  String        @id @default(cuid())
  code String? //kode antrian
  warehouseId         String
  dockId              String?
  vehicleId           String
  //booking field
  arrivalTime         DateTime
  estimatedFinishTime DateTime
  
  actualArrivalTime   DateTime? //ini konfirmasi sudah sampai
  //unloading times
  actualStartTime DateTime?
  actualFinishTime    DateTime? //ini kenyataannya
  status              String // lihat shared-enum
  notes               String?

  Vehicle   Vehicle   @relation(fields: [vehicleId], references: [id])
  Warehouse Warehouse @relation(fields: [warehouseId], references: [id])
  Dock      Dock?     @relation(fields: [dockId], references: [id])

  driverUsername       String
  driver         User    @relation("bookingDriver", fields: [driverUsername], references: [username])
  
  canceledReason String?
  durasiBongkarEstimasi  Int?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  createByUsername String?
  createdBy User? @relation("bookingCreatedBy", fields: [createByUsername], references: [username])
  organizationName String
  organization     Organization @relation(fields: [organizationName], references: [name])
}

model User {
  username     String   @id
  passwordHash String? // kalau pakai auth lokal
  description  String? //ini hanya untuk inisialisasi ROLE saja pas login pertama
  role String @default("ADMIN_VENDOR")
  
  isActive     Boolean  @default(true)
  displayName  String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  mail String?

  driverPhone   String?
  driverLicense String?

  // homeWarehouse = staff biasa (nullable)
  homeWarehouseId String?
  homeWarehouse   Warehouse? @relation("UserHomeWarehouse", fields: [homeWarehouseId], references: [id])
  accountType String @default("AD")

  //many-to-many 
  warehouseAccess Warehouse[]
  createdBooking Booking[] @relation("bookingCreatedBy")
  bookingAsDriver Booking[] @relation("bookingDriver") 
  vendorName String?
  vendor Vendor? @relation(fields: [vendorName], references: [name])
  organizations Organization[]
}

model Vendor {
  name String @id
  members User[]
  organizationName String
  organization Organization @relation(fields: [organizationName], references: [name])
}

// CHAT FEATURE
model Room {
  id            String   @id @default(cuid()) //harusnya bukan cuid tapi custom
  createdAt     DateTime @default(now())
  lastMessageAt DateTime?

  chats         Chat[]
}

model Chat {
  id        String   @id @default(cuid())
  roomId    String
  senderId  String   // refer ke User (tidak perlu relasi Prisma kalau sudah kompleks)
  message   String
  status    String   //read, delivered
  
  createdAt DateTime @default(now())

  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId, createdAt])
}


